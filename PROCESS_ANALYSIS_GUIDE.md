# 工序分析功能使用指南

> **製造業專業功能 - 自動識別加工訊號中的待機與工序**
>
> 版本: 2.1.2
> 功能位置: Tab 7 - 實用工具 → 工序分析
> 適用場景: CNC 加工、機械製造、生產線監控

---

## 📋 功能概述

工序分析功能可以自動分析長時間的加工訊號，智慧識別：
- ⏸️ **待機時段**：機台空閒、未進行加工的時間
- 🔧 **加工段落**：實際進行加工的完整時間段
- ⚙️ **工序步驟**：每個加工段內的細分工序

### 應用場景

1. **生產效率分析**
   - 計算實際加工時間佔比
   - 識別無效待機時間
   - 優化生產排程

2. **工序時間研究**
   - 分析各工序耗時
   - 找出瓶頸工序
   - 標準化作業時間

3. **品質追溯**
   - 記錄每個工序的詳細數據
   - 定位異常工序
   - 建立工序資料庫

---

## 🎯 核心演算法

### Step 1: 待機判定

**邏輯**:
```
IF 訊號絕對值 < 待機閾值
   AND 持續時間 > 待機秒數
THEN 判定為待機狀態
```

**參數**:
- `待機閾值`: 低於此值視為機台空轉
- `待機秒數`: 持續多久才算真正待機（避免誤判短暫停頓）

### Step 2: 加工段提取

**邏輯**:
```
加工開始 = 從待機狀態超過閾值
加工結束 = 進入下一次待機
完整加工段 = 加工開始 到 加工結束
```

**輸出**:
- 多個完整的加工時間段
- 每段的起始和結束時間

### Step 3: 工序分割

**邏輯**:
```
在每個加工段內:
1. 計算 99.9 分位數閾值（代表峰值操作）
2. 超過此閾值 = 新工序開始
3. 在工序起始點繪製紅色垂直線
```

**為什麼是 99.9 分位數?**
- 排除極端值干擾
- 保留真實的峰值操作特徵
- 穩定且可靠的工序識別

### Step 4: 分析報告

自動生成包含：
- 總加工時間和佔比
- 各加工段統計
- 各工序詳細時長
- 平均/最小/最大工序時長

---

## 🚀 使用步驟

### 準備工作

1. **載入數據**
   ```
   Tab 1 → 選擇 CSV 檔案 → 選擇訊號欄位
   ```

2. **確認數據**
   - 確保訊號包含加工過程
   - 數據長度足夠（建議 > 1 分鐘）
   - 訊號品質良好

### 參數設定

切換到 **Tab 7 - 實用工具** → 工序分析區塊

#### 1. 取樣率 (Hz)
- **說明**: 訊號的採樣頻率
- **預設值**: 10000 Hz
- **如何設定**:
  - 從檔案資訊查看
  - 或使用 Tab 1 自動計算的值
- **範例**:
  - 高速加工: 20000 Hz
  - 一般加工: 10000 Hz
  - 慢速加工: 5000 Hz

#### 2. 待機閾值
- **說明**: 低於此值判定為待機
- **預設值**: 0.5
- **如何設定**:
  - 觀察訊號的基線值
  - 略高於雜訊水準
  - 建議為訊號最大值的 5-10%
- **範例**:
  - 訊號範圍 -10 ~ +10 → 設定 0.5
  - 訊號範圍 -50 ~ +50 → 設定 2.5

#### 3. 待機秒數 (s)
- **說明**: 持續多久才算待機
- **預設值**: 2.0 秒
- **如何設定**:
  - 短於正常工序間隔
  - 避免將短暫停頓誤判為待機
  - 考慮機台特性
- **範例**:
  - 快速換刀: 1.0 秒
  - 一般停頓: 2.0 秒
  - 長時間待機: 5.0 秒

### 執行分析

1. 點擊「🔬 開始工序分析」
2. 等待分析完成（顯示進度條）
3. 自動彈出分析報告視窗

---

## 📊 分析結果解讀

### 報告視窗結構

#### Tab 1: 分析報告

```
======================================================================
工序分析報告
======================================================================

📊 總體統計
   總訊號長度: 600.00 秒 (10 分鐘)
   總樣本數: 6,000,000
   取樣率: 10,000 Hz

🔧 加工段分析
   加工段數量: 3

   加工段 1:
      時間範圍: 0.50s ~ 180.30s
      持續時間: 179.80 秒
      包含工序數: 5

   加工段 2:
      時間範圍: 250.00s ~ 400.50s
      持續時間: 150.50 秒
      包含工序數: 4

   加工段 3:
      時間範圍: 480.00s ~ 590.00s
      持續時間: 110.00 秒
      包含工序數: 3

   總加工時間: 440.30 秒
   加工時間佔比: 73.4%

⚙️ 工序詳細分析
   總工序數量: 12

   工序 1-1:
      開始時間: 0.50 秒
      結束時間: 35.20 秒
      持續時間: 34.70 秒

   工序 1-2:
      開始時間: 35.20 秒
      結束時間: 72.80 秒
      持續時間: 37.60 秒

   ... (其他工序)

📈 工序統計
   平均工序時長: 36.69 秒
   最短工序時長: 28.50 秒
   最長工序時長: 45.80 秒

======================================================================
```

#### Tab 2: 視覺化圖表

**上圖 - 待機與加工識別**:
- 藍色曲線: 原始訊號
- 灰色區域: 待機時段
- 綠色區域: 加工時段
- 紅色虛線: 待機閾值

**下圖 - 工序分割詳細視圖**:
- 藍色曲線: 原始訊號
- 紅色垂直線: 工序開始點

### 關鍵指標說明

#### 1. 加工時間佔比
```
加工時間佔比 = (總加工時間 / 總訊號長度) × 100%
```
- **優秀**: > 80%
- **良好**: 60-80%
- **需改善**: < 60%

**低佔比原因**:
- 過多待機時間
- 頻繁換刀/調整
- 排程不佳

#### 2. 工序數量
- **合理工序數**: 取決於加工複雜度
- **過多工序**: 可能需要整合
- **過少工序**: 可能參數需調整

#### 3. 工序時長分佈
- **平均值**: 代表典型工序時間
- **最大值**: 可能是瓶頸工序
- **最小值**: 可能是簡單操作

---

## 💡 實戰範例

### 範例 1: CNC 銑床加工分析

**場景**:
- 10 分鐘的 CNC 銑床振動訊號
- 包含粗銑、精銑、鑽孔等工序

**參數設定**:
```
取樣率: 10000 Hz
待機閾值: 0.8
待機秒數: 3.0
```

**分析結果**:
```
加工段數量: 2
工序數量: 8
加工時間佔比: 68.5%
平均工序時長: 51.2 秒
```

**解讀**:
- 2 個加工段: 可能是兩個零件
- 8 個工序: 每個零件約 4 道工序
- 佔比 68.5%: 有改善空間，待機時間稍多

**改善建議**:
- 優化換刀時間
- 縮短工件定位時間
- 考慮批次加工

---

### 範例 2: 衝床連續作業

**場景**:
- 5 分鐘的衝床力訊號
- 連續衝壓作業

**參數設定**:
```
取樣率: 20000 Hz
待機閾值: 1.5
待機秒數: 1.0
```

**分析結果**:
```
加工段數量: 1
工序數量: 45
加工時間佔比: 92.3%
平均工序時長: 6.1 秒
```

**解讀**:
- 1 個加工段: 連續作業
- 45 個工序: 45 次衝壓
- 佔比 92.3%: 效率極高
- 工序時長 6.1 秒: 穩定的節拍

---

### 範例 3: 多工序加工中心

**場景**:
- 15 分鐘複雜零件加工
- 包含銑削、鑽孔、攻牙

**參數設定**:
```
取樣率: 10000 Hz
待機閾值: 0.6
待機秒數: 2.5
```

**分析結果**:
```
加工段數量: 3
工序數量: 15
加工時間佔比: 74.8%
平均工序時長: 44.8 秒
最長工序: 95.3 秒 (工序 2-3)
```

**解讀**:
- 工序 2-3 耗時最長: 可能是瓶頸
- 需要深入分析工序 2-3
- 考慮優化該工序參數

---

## ⚙️ 參數調優指南

### 問題 1: 待機時段未被識別

**症狀**: 明明有停頓，但未標記為待機

**原因**:
- 待機閾值設定太低
- 待機秒數設定太長

**解決方案**:
```
1. 提高待機閾值 (例如: 0.5 → 1.0)
2. 縮短待機秒數 (例如: 2.0 → 1.0)
3. 觀察 Tab 1 的訊號波形，找到真實的待機水準
```

---

### 問題 2: 誤判過多待機

**症狀**: 正常加工也被標記為待機

**原因**:
- 待機閾值設定太高
- 訊號中有低振幅加工段

**解決方案**:
```
1. 降低待機閾值 (例如: 1.0 → 0.3)
2. 增加待機秒數，避免短暫低振幅被誤判 (例如: 2.0 → 3.0)
```

---

### 問題 3: 工序分割太少

**症狀**: 明顯有多個操作，但只識別出 1-2 個工序

**原因**:
- 99.9 分位數太高，錯過了次要峰值
- 加工段內振幅變化不明顯

**解決方案**:
```
1. 這是演算法限制，99.9 分位數專門識別最顯著的工序
2. 考慮手動分析更細緻的工序
3. 或降低到 99.5 分位數（需修改代碼）
```

---

### 問題 4: 工序分割過多

**症狀**: 工序數量遠超預期

**原因**:
- 訊號中有突波干擾
- 99.9 分位數對雜訊敏感

**解決方案**:
```
1. 先在 Tab 5 使用低通濾波器過濾高頻雜訊
2. 然後再進行工序分析
3. 或提高到 99.95 分位數（需修改代碼）
```

---

## 📁 輸出檔案

### 自動生成

- **圖表**: `process_analysis_result.png`
  - 位置: 程式執行目錄
  - 格式: PNG
  - 解析度: 150 DPI
  - 包含兩個子圖

### 手動儲存

- **報告**: 點擊「💾 儲存報告」
  - 格式: TXT
  - 編碼: UTF-8
  - 內容: 完整文字報告

---

## 🔧 進階應用

### 1. 批次分析多個檔案

**場景**: 需要分析一整天的加工記錄

**方法**:
```python
# 自行編寫腳本
for file in files:
    load_data(file)
    run_process_analysis()
    save_report(f"{file}_report.txt")
```

### 2. 匯出到資料庫

**應用**: 建立工序時間資料庫

**步驟**:
1. 儲存報告為 TXT
2. 解析報告提取數據
3. 寫入資料庫
4. 用於生產計劃和排程

### 3. 與 MES 系統整合

**價值**:
- 即時監控加工進度
- 自動計算實際工時
- 追溯工序品質

---

## ❓ 常見問題

### Q1: 需要什麼樣的數據？

**A**:
- CSV 格式
- 包含時間戳和數值欄位
- 訊號連續且完整
- 建議長度 > 1 分鐘

---

### Q2: 可以分析電流訊號嗎？

**A**:
可以！只要是反映加工狀態的連續訊號都適用：
- ✅ 振動加速度
- ✅ 電流/功率
- ✅ 聲音強度
- ✅ 力/扭矩訊號

---

### Q3: 分析需要多久？

**A**:
取決於訊號長度：
- 1 分鐘數據: < 5 秒
- 10 分鐘數據: < 30 秒
- 1 小時數據: < 3 分鐘

---

### Q4: 可以修改 99.9 分位數嗎？

**A**:
可以，在代碼第 1412 行：
```python
step_threshold = np.percentile(np.abs(segment_signal), 99.9)
```
修改為：
```python
step_threshold = np.percentile(np.abs(segment_signal), 99.5)  # 更敏感
```

---

### Q5: 報告可以匯出 Excel 嗎？

**A**:
目前支援 TXT 格式。如需 Excel：
1. 儲存 TXT 報告
2. 使用 Excel 打開並格式化
3. 或自行開發匯出功能

---

## 📞 技術支援

### 相關文檔
- `DEMO_GUIDE.md` - 完整系統使用指南
- `README_V2.1.md` - 系統總覽
- `UPDATE_v2.1.1.md` - 實用工具更新說明

### 問題回報
遇到問題請提供：
1. 使用的參數設定
2. 訊號數據特徵
3. 預期結果 vs 實際結果
4. 錯誤訊息（如有）

---

<div align="center">

**SignalVizTool v2.1.2 - 工序分析功能**

*讓製造數據說話*

**專業 · 準確 · 高效**

---

From Demo Tool to Manufacturing Intelligence Platform

</div>
